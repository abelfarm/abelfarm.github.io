<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Pro</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="main-layout">
        <div id="chart-wrapper">

            <div class="header">
                <input type="text" id="stock-input" placeholder="Mã CP">
                <select id="timeframe-select">
                    <option value="5m">5 Phút</option>
                    <option value="1h">1 Giờ</option>
                    <option value="1d" selected>1 Ngày</option>
                    <option value="1w">1 Tuần</option>
                </select>
                <button id="search-btn">XEM</button>
                <div class="range-selector">
                    <button onclick="window.applyRange(90)">3T</button>
                    <button onclick="window.applyRange(180)">6T</button>
                    <button onclick="window.applyRange(365)">1N</button>
                    <button onclick="window.applyFullRange()">FULL</button>
                </div>
            </div>

            <div id="chart-container">
                <div id="legend" class="ohlc-legend"></div>
            </div>
        </div>
        <div id="fundamental-panel">
            <div class="company-name" id="comp-name">Tên Công Ty</div>
            <p id="comp-desc" style="font-size: 13px; color: #848e9c; line-height: 1.4;"></p>
            
            <div class="info-card">
                <h4 style="margin-top:0">Chỉ số tài chính</h4>
                <div class="info-row"><span class="info-label">Vốn hóa:</span> <span class="info-value" id="val-cap">-</span></div>
                <div class="info-row"><span class="info-label">P/E:</span> <span class="info-value" id="val-pe">-</span></div>
                <div class="info-row"><span class="info-label">EPS:</span> <span class="info-value" id="val-eps">-</span></div>
                <div class="info-row"><span class="info-label">ROE:</span> <span class="info-value" id="val-roe">-</span></div>
                <div class="info-row"><span class="info-label">Cổ tức:</span> <span class="info-value" id="val-div">-</span></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Kiểm tra xem thư viện đã sẵn sàng chưa
    if (typeof LightweightCharts === 'undefined') {
        console.error("Thư viện LightweightCharts chưa được tải!");
        return;
    }

    const container = document.getElementById('chart-container');
    
    // Khởi tạo biểu đồ
    const chart = LightweightCharts.createChart(container, {
        layout: { 
            background: { color: '#131722' }, 
            textColor: '#d1d4dc' 
        },
        grid: { 
            vertLines: { color: '#2a2e39' }, 
            horzLines: { color: '#2a2e39' } 
        },
        timeScale: { 
            timeVisible: true, 
            secondsVisible: false 
        }
    });

    // Tạo series nến
    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', 
        downColor: '#ef5350', 
        borderVisible: false,
        wickUpColor: '#26a69a', 
        wickDownColor: '#ef5350'
    });

    // Tạo series volume
    const volumeSeries = chart.addHistogramSeries({
        priceFormat: { type: 'volume' },
        priceScaleId: 'volume',
    });

    // Cấu hình scale cho Volume
    chart.priceScale('volume').applyOptions({
        scaleMargins: { top: 0.8, bottom: 0 },
        visible: false
    });

    // ĐỊNH NGHĨA HÀM ZOOM VÀO ĐỐI TƯỢNG WINDOW ĐỂ HTML GỌI ĐƯỢC
    window.applyRange = (days) => {
        const data = candlestickSeries.data();
        if (!data.length) return;
        const to = data[data.length - 1].time;
        const toDate = (typeof to === 'string') ? new Date(to) : new Date(to * 1000);
        const fromDate = new Date(toDate);
        fromDate.setDate(fromDate.getDate() - days);
        
        const from = (typeof to === 'string') 
            ? fromDate.toISOString().split('T')[0] 
            : Math.floor(fromDate.getTime() / 1000);

        chart.timeScale().setVisibleRange({ from, to });
    };

    window.applyFullRange = () => chart.timeScale().fitContent();

    // Hàm tải dữ liệu
    window.loadData = (ticker) => {
        const tf = document.getElementById('timeframe-select').value;
        const fileName = `./data/${ticker.toUpperCase()}.json`; //_${tf}

        fetch(fileName)
            .then(res => {
                if (!res.ok) throw new Error("Không tìm thấy file " + fileName);
                return res.json();
            })
            .then(data => {
                data.sort((a, b) => (typeof a.time === 'string' ? new Date(a.time) : a.time) - (typeof b.time === 'string' ? new Date(b.time) : b.time));

                // TẠO BIẾN DỮ LIỆU BÊN TRONG KHỐI .THEN
                const candleData = data.map(d => ({
                    time: d.time, 
                    open: parseFloat(d.open), 
                    high: parseFloat(d.high), 
                    low: parseFloat(d.low), 
                    close: parseFloat(d.close)
                }));

                const volumeData = data.map(d => ({
                    time: d.time, 
                    value: parseFloat(d.value || d.volume),
                    color: d.close >= d.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
                }));

                // Đưa dữ liệu vào Series
                candlestickSeries.setData(candleData);
                volumeSeries.setData(volumeData);

                // GỌI HÀM CẬP NHẬT LEGEND TẠI ĐÂY (Vì lúc này candleData mới tồn tại)
                const lastCandle = candleData[candleData.length - 1];
                const lastVol = volumeData[volumeData.length - 1].value;
                updateLegend(lastCandle, ticker, lastVol);

                // Lưu vào bộ nhớ (localStorage)
                localStorage.setItem('lastTicker', ticker);
                localStorage.setItem('lastTF', tf);
                
                // --- THAY ĐỔI TẠI ĐÂY: CHỈ HIỂN THỊ 1 NĂM KHI LOAD ---
                if (candleData.length > 0) {
                    const lastDate = candleData[candleData.length - 1].time;
                    let fromDate;

                    // Kiểm tra định dạng thời gian là chuỗi "YYYY-MM-DD" hay timestamp
                    if (typeof lastDate === 'string') {
                        const dateObj = new Date(lastDate);
                        dateObj.setFullYear(dateObj.getFullYear() - 1); // Trừ đi 1 năm
                        fromDate = dateObj.toISOString().split('T')[0];
                    } else {
                        // Nếu là timestamp (số giây)
                        fromDate = lastDate - (365 * 24 * 60 * 60);
                    }

                    // Áp dụng vùng hiển thị (Zoom)
                    chart.timeScale().setVisibleRange({
                        from: fromDate,
                        to: lastDate,
                    });
                }
            })
            .catch(err => alert(err.message));
        
        
    };

    const legend = document.getElementById('legend');

    // Hàm hiển thị thông tin lên Legend
    function updateLegend(candle, ticker, volumeValue) {
        if (!candle) return;
        
        // Hiển thị legend nếu lỡ bị ẩn
        legend.style.display = 'block'; 

        const isUp = candle.close >= candle.open;
        const colorStyle = isUp ? 'color: #26a69a;' : 'color: #ef5350;';
        const change = (candle.close - candle.open).toFixed(2);
        const percent = ((change / candle.open) * 100).toFixed(2);
        const sign = change > 0 ? '+' : '';
        
        // Lấy tên mã cổ phiếu từ input hoặc mặc định
        const displayName = ticker || "N/A";

        legend.innerHTML = `
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px; ${colorStyle}">
                ${displayName.toUpperCase()} 
                <span style="font-size: 14px; font-weight: normal;">${sign}${percent}%</span>
            </div>
            <div style="color: #848e9c; font-size: 12px; margin-bottom: 5px;">
                ${candle.time}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 10px; font-size: 13px;">
                <div>O: <span style="color: #d1d4dc">${candle.open}</span></div>
                <div>H: <span style="color: #d1d4dc">${candle.high}</span></div>
                <div>L: <span style="color: #d1d4dc">${candle.low}</span></div>
                <div>C: <span style="color: #d1d4dc">${candle.close}</span></div>
            </div>
            <div style="margin-top: 5px; font-size: 12px; color: #848e9c;">
                Vol: <span style="color: #d1d4dc">${(volumeValue / 1000000).toFixed(2)}M</span>
            </div>
        `;
    }

    // Lắng nghe di chuyển chuột
    chart.subscribeCrosshairMove(param => {
        const ticker = document.getElementById('stock-input').value || 'CP';
    
        // Nếu chuột trong vùng biểu đồ
        if (param.time && param.point && param.point.x >= 0) {
            const candle = param.seriesData.get(candlestickSeries);
            const vol = param.seriesData.get(volumeSeries);
            if (candle) updateLegend(candle, ticker, vol ? vol.value : 0);
        } 
        // Nếu chuột ra ngoài, hiện lại nến cuối cùng
        else {
            const allData = candlestickSeries.data();
            if (allData.length > 0) {
                const last = allData[allData.length - 1];
                const allVol = volumeSeries.data();
                const lastVol = allVol.length > 0 ? allVol[allVol.length - 1].value : 0;
                updateLegend(last, ticker, lastVol);
            }
        }
    });

    

    // Sự kiện tìm kiếm
    document.getElementById('search-btn').onclick = () => {
        loadData(document.getElementById('stock-input').value.trim());
    };

    // Lấy các phần tử giao diện
    const stockInput = document.getElementById('stock-input');
    const searchBtn = document.getElementById('search-btn');

    // Hàm thực hiện tìm kiếm và hiển thị
    function handleSearch() {
        const ticker = stockInput.value.trim().toUpperCase();
        if (ticker) {
            loadData(ticker); // Gọi hàm tải dữ liệu (đã viết ở các bước trước)
            stockInput.blur(); // Ẩn bàn phím/bỏ focus sau khi nhấn Enter
        } else {
            alert("Vui lòng nhập mã cổ phiếu!");
        }
    }

    // Lắng nghe sự kiện nhấn phím Enter trên ô nhập liệu
    stockInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSearch();
        }
    });

    // Lắng nghe sự kiện nhấn nút Tìm kiếm
    searchBtn.addEventListener('click', handleSearch);

    // Khởi tạo mã cũ
    const last = localStorage.getItem('lastTicker') || 'VIC';
    const lastTF = localStorage.getItem('lastTF') || '1d';
    document.getElementById('stock-input').value = last;
    document.getElementById('timeframe-select').value = lastTF;
    loadData(last);

    // Resize
    window.onresize = () => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
});
</script>
</body>
</html>
